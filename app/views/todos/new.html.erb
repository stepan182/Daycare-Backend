<br/>

<div class="col-md-8 col-md-offset-2">
	<div class="panel panel-default">
		<div class="panel-heading">
		  <h4>Add To Do's for customers</h4>
  		</div>

		<div class="panel-body">
					
		<%= form_tag(todos_path, html: { multipart: true }) do |f| %>
		  
		      <div class="form-group">
              <%= label_tag :choose_country%>
              <%= country_select :country, nil, {}, {prompt: 'Please select a country', class: "form-control", onchange: "showCustomers()", id: "country_sel"  } %>
          </div>
          
          <div class="form-group" id="ct">
              <%= label_tag :customer_type_id%>
              <%= select(:customer_type_name, :customer_type_id, @type_providers.map { |cust| [cust.type_name.html_safe, cust.id] }, {include_blank: true}, {class: 'form-control', onchange: 'showCustomers();getUserTypes();'}) %>
            </div>

            <div class="form-group" id="sel_franchise">
              <%= label_tag :franchise %>
              <%= select(:franchise_name, :franchise_id, @franchises.map { |f| [f.franchise_name.html_safe, f.id] }, {include_blank: true}, {class: 'form-control fr', onchange: 'showCustomers();getUserTypes();'}) %>
            </div>

            <div class="form-group" id="sel_partner">
              <%= label_tag :partner %>
              <%= select(:partner_name, :partner_id, @partners.map { |f| [f.partner_name.html_safe, f.id] }, {include_blank: true}, {class: 'form-control pr', onchange: 'showCustomers();getUserTypes();'}) %>
            </div>

            <div class="form-group" id="ut">
              <%= label_tag :user_type %>
              <%= select(:user_type_name, :user_type_id, "<option></option>".html_safe, {}, {class: 'form-control ut', onchange: 'showCustomers("true")'}) %>
            </div>
          
          <div class="form-group" id="customerNames">
            <div class="pull-right">select all <input type="checkbox" id="select_all_customers"/></div>
            <label>Choose customer</label>
            
              <div class="nameBox pull-right" id="cNames">
                
              </div>
              
          </div>
          <br/>
          
          <b>To Do</b>
          <div class="panel-footer">
            <table width="100%" class="form-inline m" id="todoTable"><tr>
            <td align="center"><b>Subject</b></td>
            <td><input class="form-control c" id="subject" name="subject" required="required" style="margin-left: 0px;" type="text" value="" /></td>
            <td></td>
            <td><a href="javascript:void(0);" onclick="addTask(1,this)" id="lnkTasks">+ add new task</a></td>
            </tr>
            
            <tr>
            <td></td>
            <td colspan="2"><b>Task</b> <input class="form-control c" id="task[0]" name="task[0]" required="required" type="text" /></td>
            <td><a href="javascript:void(0);" onclick="addSubTask(0,this)" id="lnkSubTasks">+ add new subtask</a></td>
            </tr>
            
            <tr>
            <td></td>
            <td align="center" colspan="2"><b>SubTask</b> <input class="form-control c" id="subtask[0][0]" name="subtask[0][0]" type="text" /></td>
            <td><a href="javascript:void(0);" onclick="$(this).closest('tr').remove();">&times;</a></td>
            </tr>
            
            </table><br/>
          </div>
            
          <br class="clear" /><br/>
          <div class="col-md-offset-5">
              <%= submit_tag "Submit", class: "btn btn-primary" %>
          </div>
          
        <% end %>
					
		</div>
		
	</div>
</div>

<!-- Scripts and styles -->
<script>
var ni = 0;
var pi = 1;

function addTask(taskNum,i){
  pi = 1;
  var index = $(i).closest('td').parent()[0].sectionRowIndex;      
  var rowCount = $('#todoTable tr').length;
  
  document.getElementById("todoTable").insertRow(parseInt(rowCount)).innerHTML = '<tr><td></td>'
            +'<td colspan="2"><b>Task</b> <input class="form-control c" id="task['+ taskNum +']" name="task['+ taskNum +']" type="text" /></td>'
            +'<td><a href="javascript:void(0);" onclick="addSubTask('+ parseInt(taskNum) +',this)" id="lnkSubTasks">+ add new subtask</a></td></tr>'
            
  document.getElementById("todoTable").insertRow(parseInt(rowCount)+1).innerHTML =  '<tr><td></td>'
            +'<td align="center" colspan="2"><b>SubTask</b> <input class="form-control c" id="subtask['+ taskNum +'][0]" name="subtask['+ taskNum +'][0]" type="text" /></td>'
            +'<td><a href="javascript:void(0);" onclick="$(this).closest(\'tr\').remove();">&times;</a></td>'
            +'</tr>'
  
  $("#lnkTasks").attr("onclick", "addTask("+ (parseInt(taskNum) + 1) +",this)");
}

function addSubTask(taskNum,i){
  ni += 1;
  pi += 1;
  var index = $(i).closest('td').parent()[0].sectionRowIndex;
  
  document.getElementById("todoTable").insertRow(parseInt(index) + 1).innerHTML = '<tr><td></td>'
            +'<td align="center" colspan="2"><b>SubTask</b> <input class="form-control c" id="subtask['+ taskNum +']['+ ni +']" name="subtask['+ taskNum +']['+ ni +']" type="text" /></td>'
            +'<td><a href="javascript:void(0);" onclick="$(this).closest(\'tr\').remove();">&times;</a></td></tr>'
  $("#lnkSubTasks").attr("onclick", "addSubTask("+ parseInt(taskNum) +",this,"+ ni +")");
}



// ####### End Tasks


  function showCustomers(incl){
        partnerVal = $("#partner_name_partner_id").val();
        franchiseVal = $("#franchise_name_franchise_id").val();

    // franchise
        if ($("#customer_type_name_customer_type_id").val() == "2"){
          $("#sel_franchise").show();
          $("#sel_partner").hide();
          partnerVal = "";
        }
        //partner
        else if ($("#customer_type_name_customer_type_id").val() == "3") {
          $("#sel_partner").show();
          $("#sel_franchise").hide();
          franchiseVal = "";
        }
        //single
        else if ($("#customer_type_name_customer_type_id").val() == "1") {
          $("#sel_franchise").hide();
          $("#sel_partner").hide();
          partnerVal = "";
          franchiseVal = "";
        }

        if (incl=="true"){
            var uType = $("#user_type_name_user_type_id").val();
        }
        else{
            var uType = "";
        }

        $.post("/privileges/get_customers_by_country",
            {
                country: $("#country_sel").val(),
                customer_type_id: $("#customer_type_name_customer_type_id").val(),
                user_type_id: uType,
                partner_id: partnerVal,
                franchise_id: franchiseVal
            },
            
            function(data){
                
                $("#cNames").empty();
                
                $.each(data, function(i, item) {
                    $("#cNames").append('<label for="chk'+ i +'"><input type="checkbox" name="customer_id[]" id="chk'+ i +'" value="'+ item.id +'"> '+ item.customer_name +'</label><br/>');
                });
                
                  
            } , "json");
        
        $("#ct").show();

        $("#customerNames").show();
        
    }

    function getUserTypes(){
        $.post("/user_types/get_user_types",
            {
                customer_type: $("#customer_type_name_customer_type_id").val(),
                partner_id: partnerVal,
                franchise_id: franchiseVal
            },
            
            function(data){
                
                $(".ut").empty();
                $(".ut").append("<option></option>");
                
                $.each(data, function(i, item) {
                    $(".ut").append('<option value="'+ item.id +'">'+ item.user_type_name +'</option>');
                });
                
                  
            } , "json");

        $("#ut").show();
    }

    $(function(){
        $("#slogan").html("FUNCTIONALITY");
        
        $("#customerNames").hide();
        $("#ct").hide();
        $("#ut").hide();
        $("#sel_franchise").hide();
        $("#sel_partner").hide();
        
        
        $('#select_all_customers').change(function(){
            var checkboxes = $(this).closest('form').find('#customerNames :checkbox');
            if($(this).prop('checked')) {
              checkboxes.prop('checked', true);
            } else {
              checkboxes.prop('checked', false);
            }
        });
        
        
        $('form').submit(function(e) {
            if($("input:checked").length == 0){
            alert('please select atleast one Customer!');
            return false;
            }
        });
        
    })
</script>

<style>
#topbar {
    background-color: #bd2926;
}
.nameBox { 
    border:2px solid #ccc;
    width:100%; 
    height: 200px; 
    overflow-y: scroll;
    padding: 10px;
    text-align:left;
    margin-bottom:10px;
}
.c {
  width: 70% !important;
  margin: 7px;
}

.m{
  border: 1px solid #ccc;
}
</style>